<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UJJAIN CHAT | FUTURE</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.15); --neon: #00f2fe; --accent: #4facfe; }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', sans-serif}
        body { background: #0f2027; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: white; }
        header { background: var(--glass); backdrop-filter: blur(15px); padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .btns { display: flex; gap: 4px; align-items: center; }
        .btns button { padding: 6px 10px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #fff; font-weight: 600; cursor: pointer; font-size: 9px; }
        .btns button:hover { background: var(--neon); color: #000; box-shadow: 0 0 10px var(--neon); }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: linear-gradient(rgba(15, 32, 39, 0.85), rgba(15, 32, 39, 0.85)), url('https://www.transparenttextures.com/patterns/dark-matter.png'), url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?auto=format&fit=crop&w=1350&q=80'); background-size: cover; }
        #video-container { display: none; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: rgba(0,0,0,0.7); }
        .video-view { width: 100%; height: 140px; background: #000; border-radius: 12px; border: 2px solid var(--neon); overflow: hidden; position: relative; }
        .bubble { padding: 12px 18px; border-radius: 20px; max-width: 80%; backdrop-filter: blur(8px); animation: slideIn 0.3s ease-out; }
        .me { align-self: flex-end; background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); color: #000; }
        .other { align-self: flex-start; background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .input-area { background: var(--glass); backdrop-filter: blur(20px); padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .input-area input { flex: 1; padding: 12px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; outline: none; }
        #login-screen { position: fixed; inset: 0; background: #0f2027; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: var(--glass); backdrop-filter: blur(20px); padding: 30px; border-radius: 25px; text-align: center; width: 90%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h1 style="color: var(--neon); text-shadow: 0 0 15px var(--neon);">UJJAIN CHAT</h1>
        <select id="nameSelect" style="width:100%; padding:12px; margin:20px 0; border-radius:10px; background:rgba(0,0,0,0.5); color:#fff; border:1px solid var(--neon);">
            <option value="Adhyan Sarthak">Adhyan Sarthak</option>
            <option value="Sweta Kumari">Sweta Kumari</option>
            <option value="Mummy">Mummy</option>
            <option value="Papa">Papa</option>
            <option value="Ananya Anand">Ananya Anand</option>
        </select>
        <button onclick="login()" style="width:100%; padding:15px; background:var(--neon); border:none; border-radius:50px; font-weight:bold; cursor:pointer; box-shadow: 0 0 15px var(--neon);">JOIN FAMILY</button>
    </div>
</div>

<header>
    <div style="display: flex; flex-direction: column;">
        <b style="color: var(--neon); font-size: 16px; text-shadow: 0 0 10px var(--neon);">UJJAIN CHAT üè°</b>
        <small style="font-size: 9px; opacity: 0.7; letter-spacing: 1px;">FAMILY SYSTEM</small>
    </div>
    <div class="btns">
        <button id="v-btn" onclick="startCall(true)">üìπ VIDEO</button>
        <button id="a-btn" onclick="startCall(false)">üìû VOICE</button>
        <button id="mute-btn" onclick="toggleMute()" style="display:none; border-color: #f39c12;">üé§ MUTE</button>
        <button id="cam-btn" onclick="toggleCam()" style="display:none; border-color: #f39c12;">üì∑ CAM</button>
        <button id="end-btn" onclick="stopEverything()" style="background:#ff4444; display:none; border:none;">‚ùå END</button>
        <button onclick="logoutSystem()" style="color: #bbb; border:none; background:transparent; font-size: 10px; margin-left: 5px;">EXIT</button>
    </div>
</header>

<div id="video-container"></div>
<div id="chat-box"></div>
<div id="typing-box" style="padding: 2px 20px; font-size: 10px; color: var(--neon); height: 15px; background: rgba(0,0,0,0.2);"></div>

<form class="input-area" id="chat-form">
    <label style="cursor:pointer; font-size: 20px;">üñºÔ∏è<input type="file" id="img-input" accept="image/*" style="display:none" onchange="uploadImage(this)"></label>
    <input id="msg-input" placeholder="Transmission..." autocomplete="off" oninput="sendTyping()">
    <button type="submit" style="background:var(--neon); border:none; padding:10px 20px; border-radius:50px; font-weight:bold; cursor:pointer; box-shadow: 0 0 10px var(--neon);">SEND</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtsDXCwGOv8ym4RPn3EziO2O8zuaSDTGc",
    authDomain: "chatword-4d676.firebaseapp.com",
    projectId: "chatword-4d676",
    storageBucket: "chatword-4d676.appspot.com",
    messagingSenderId: "434457097920",
    appId: "1:434457097920:web:61678bc766f8e398b35f25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "family_chat");
const user = localStorage.getItem("family_user");

if (user) document.getElementById("login-screen").style.display = "none";
window.login = () => { localStorage.setItem("family_user", document.getElementById("nameSelect").value); location.reload(); };
window.logoutSystem = () => { if(confirm("Exit UJJAIN CHAT?")) { localStorage.removeItem("family_user"); location.reload(); } };

// --- CHAT LOGIC ---
document.getElementById("chat-form").onsubmit = async (e) => {
    e.preventDefault();
    const val = document.getElementById("msg-input").value.trim();
    if(val) { await addDoc(colRef, { sender: user, text: val, type: 'text', time: serverTimestamp() }); document.getElementById("msg-input").value=""; }
};

window.uploadImage = async (input) => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => { await addDoc(colRef, { sender: user, img: e.target.result, type: 'image', time: serverTimestamp() }); };
    reader.readAsDataURL(file);
};

onSnapshot(query(colRef, orderBy("time","asc")), snap => {
    const box = document.getElementById("chat-box");
    box.innerHTML = "";
    snap.forEach(d => {
        const m = d.data();
        const date = m.time ? new Date(m.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        box.innerHTML += `<div class="bubble ${m.sender === user ? 'me' : 'other'}">
            <span style="font-size:9px; font-weight:bold; display:block; opacity:0.7; color:${m.sender === user ? '#000' : 'var(--neon)'}">${m.sender}</span>
            ${m.type === 'image' ? `<img src="${m.img}" style="max-width:100%; border-radius:10px; margin:5px 0; border: 1px solid rgba(255,255,255,0.2);">` : m.text}
            <span style="font-size:8px; display:block; text-align:right; opacity:0.5;">${date}</span>
        </div>`;
    });
    box.scrollTop = box.scrollHeight;
});

// --- TYPING ---
window.sendTyping = () => {
    setDoc(doc(db, "typing", user), { typing: true, name: user, time: Date.now() });
    setTimeout(() => setDoc(doc(db, "typing", user), { typing: false }), 2000);
};

onSnapshot(collection(db, "typing"), snap => {
    let t = []; snap.forEach(d => { if(d.data().typing && d.id !== user && (Date.now() - d.data().time < 3000)) t.push(d.data().name); });
    document.getElementById("typing-box").innerText = t.length > 0 ? t.join(", ") + " is typing..." : "";
});

// --- AGORA ---
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let lAudio, lVideo;
let isMuted = false, isCamOff = false;

window.startCall = async (isVideo) => {
    await client.join("79bdf9897e5446d3a9052d69ada91767", "family_room", null);
    document.getElementById("v-btn").style.display = "none";
    document.getElementById("a-btn").style.display = "none";
    document.getElementById("end-btn").style.display = "inline-block";
    document.getElementById("mute-btn").style.display = "inline-block";
    lAudio = await AgoraRTC.createMicrophoneAudioTrack();
    if(isVideo) {
        lVideo = await AgoraRTC.createCameraVideoTrack();
        document.getElementById("cam-btn").style.display = "inline-block";
        document.getElementById("video-container").style.display = "grid";
        const div = document.createElement("div"); div.id = "me-vid"; div.className="video-view";
        document.getElementById("video-container").appendChild(div);
        lVideo.play("me-vid"); await client.publish([lAudio, lVideo]);
    } else { await client.publish([lAudio]); }
};

window.toggleMute = () => {
    isMuted = !isMuted; lAudio.setMuted(isMuted);
    document.getElementById("mute-btn").innerText = isMuted ? "üé§ UNMUTE" : "üé§ MUTE";
    document.getElementById("mute-btn").style.color = isMuted ? "#ff4444" : "#fff";
};

window.toggleCam = () => {
    isCamOff = !isCamOff; lVideo.setMuted(isCamOff);
    document.getElementById("cam-btn").innerText = isCamOff ? "üì∑ CAM ON" : "üì∑ CAM OFF";
    document.getElementById("cam-btn").style.color = isCamOff ? "#ff4444" : "#fff";
};

window.stopEverything = async () => {
    if(lAudio) { lAudio.stop(); lAudio.close(); } if(lVideo) { lVideo.stop(); lVideo.close(); }
    await client.leave(); location.reload();
};

client.on("user-published", async (u, type) => {
    await client.subscribe(u, type);
    if (type === "video") {
        document.getElementById("video-container").style.display = "grid";
        const div = document.createElement("div"); div.id = u.uid; div.className="video-view";
        document.getElementById("video-container").appendChild(div);
        u.videoTrack.play(div.id);
    }
    if (type === "audio") u.audioTrack.play();
});
client.on("user-unpublished", u => document.getElementById(u.uid)?.remove());
</script>
</body>
</html>