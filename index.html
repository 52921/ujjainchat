<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UJJAIN CHAT</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
        body{ background:#f0f2f5; height:100vh; display:flex; flex-direction:column; }
        header{ background:#4267B2; color:#fff; padding:10px; display:flex; justify-content:space-between; align-items:center; }
        .btns button{ padding:8px; border-radius:5px; border:none; color:#fff; cursor:pointer; font-weight:bold; margin-left:5px; }
        #video-container { display: none; grid-template-columns: 1fr 1fr; gap: 10px; background: #000; padding: 10px; }
        .video-view { width: 100%; height: 150px; background: #333; border-radius: 8px; position: relative; }
        #chat-box{ flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
        .bubble{ padding:10px; border-radius:15px; max-width:70%; }
        .me{ align-self:flex-end; background:#0084ff; color:#fff; }
        .other{ align-self:flex-start; background:#e4e6eb; color:#000; }
        .input-area{ padding:10px; display:flex; background:#fff; border-top:1px solid #ddd; }
        .input-area input{ flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none; }
        #login-screen{ position:fixed; inset:0; background:#4267B2; display:flex; align-items:center; justify-content:center; z-index:100; }
        .login-card{ background:#fff; padding:30px; border-radius:15px; text-align:center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>UJJAIN CHAT</h2>
        <select id="nameSelect" style="width:100%; padding:10px; margin:15px 0;">
            <option value="Adhyan Sarthak">Adhyan Sarthak</option>
            <option value="Sweta Kumari">Sweta Kumari</option>
            <option value="Mummy">Mummy</option>
            <option value="Papa">Papa</option>
            <option value="Ananya Anand">Ananya Anand</option>
        </select>
        <button onclick="login()" style="width:100%; padding:10px; background:#4267B2; color:#fff; border:none; border-radius:5px;">Join</button>
    </div>
</div>

<header>
    <div><b>UJJAIN CHAT</b></div>
    <div class="btns">
        <button id="v-btn" onclick="startVideo()" style="background:#6f42c1;">üìπ Video</button>
        <button id="end-btn" onclick="stopEverything()" style="background:#ff4444; display:none;">‚ùå End Call</button>
        <button onclick="localStorage.clear(); location.reload();" style="background:gray;">Exit</button>
    </div>
</header>

<div id="video-container"></div>
<div id="chat-box"></div>

<form class="input-area" id="chat-form">
    <input id="msg-input" placeholder="Type here...">
    <button type="submit" style="margin-left:5px; background:none; border:none; color:#0084ff; font-weight:bold;">Send</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtsDXCwGOv8ym4RPn3EziO2O8zuaSDTGc",
    authDomain: "chatword-4d676.firebaseapp.com",
    projectId: "chatword-4d676",
    storageBucket: "chatword-4d676.firebasestorage.app",
    messagingSenderId: "434457097920",
    appId: "1:434457097920:web:61678bc766f8e398b35f25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "family_chat");
const user = localStorage.getItem("family_user");

if (user) document.getElementById("login-screen").style.display = "none";
window.login = () => { localStorage.setItem("family_user", document.getElementById("nameSelect").value); location.reload(); };

// --- Chat Logic ---
document.getElementById("chat-form").onsubmit = async (e) => {
    e.preventDefault();
    const val = document.getElementById("msg-input").value;
    if(val) { await addDoc(colRef, { sender: user, text: val, time: serverTimestamp() }); document.getElementById("msg-input").value=""; }
};

onSnapshot(query(colRef, orderBy("time","asc")), snap => {
    const box = document.getElementById("chat-box");
    box.innerHTML = "";
    snap.forEach(d => {
        const m = d.data();
        box.innerHTML += `<div class="bubble ${m.sender === user ? 'me' : 'other'}"><b>${m.sender}:</b> ${m.text}</div>`;
    });
    box.scrollTop = box.scrollHeight;
});

// --- Agora Logic ---
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localTracks = [];

window.startVideo = async () => {
    await client.join("79bdf9897e5446d3a9052d69ada91767", "family_room", null);
    localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
    
    document.getElementById("video-container").style.display = "grid";
    document.getElementById("v-btn").style.display = "none";
    document.getElementById("end-btn").style.display = "inline-block";

    const div = document.createElement("div");
    div.id = "me-vid"; div.className="video-view";
    document.getElementById("video-container").appendChild(div);
    
    localTracks[1].play("me-vid");
    await client.publish(localTracks);
};

window.stopEverything = async () => {
    localTracks.forEach(t => { t.stop(); t.close(); });
    await client.leave();
    document.getElementById("video-container").innerHTML = "";
    document.getElementById("video-container").style.display = "none";
    document.getElementById("v-btn").style.display = "inline-block";
    document.getElementById("end-btn").style.display = "none";
};

client.on("user-published", async (user, mediaType) => {
    await client.subscribe(user, mediaType);
    if (mediaType === "video") {
        const div = document.createElement("div");
        div.id = user.uid; div.className="video-view";
        document.getElementById("video-container").appendChild(div);
        user.videoTrack.play(div.id);
    }
    if (mediaType === "audio") user.audioTrack.play();
});

client.on("user-unpublished", u => { document.getElementById(u.uid)?.remove(); });
</script>
</body>
</html>