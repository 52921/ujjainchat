<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UJJAIN CHAT â€“ Family Group</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
        body{ background:#f0f2f5; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* LOGIN SCREEN */
        #login-screen{ position:fixed; inset:0; background:linear-gradient(135deg,#4267B2,#2851A3); display:flex; align-items:center; justify-content:center; z-index:100; }
        .login-card{ background:#fff; padding:40px; width:90%; max-width:350px; border-radius:20px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,.2); }
        .login-card select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:15px; }
        .login-card button{ margin-top:20px; padding:12px; width:100%; border:none; border-radius:10px; background:#4267B2; color:#fff; font-weight:600; cursor:pointer; }

        /* HEADER */
        header{ background:#4267B2; color:#fff; padding:10px 15px; display:flex; justify-content:space-between; align-items:center; z-index:10; }
        .header-btns{ display:flex; gap:8px; }
        header button{ border:none; padding:8px 10px; border-radius:8px; color:#fff; cursor:pointer; font-weight:600; font-size: 0.8rem; }

        /* VIDEO AREA */
        #video-container { display: none; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #000; padding: 10px; max-height: 40vh; overflow-y: auto; }
        .video-view { width: 100%; height: 200px; background: #333; border-radius: 10px; position: relative; overflow: hidden; }
        .video-label { position: absolute; bottom: 5px; left: 5px; color: #fff; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-size: 10px; z-index: 5; }

        /* CHAT BOX */
        #chat-box{ flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:12px; background: #f0f2f5; }
        .msg{ max-width:75%; display:flex; flex-direction:column; }
        .msg.me{ align-self:flex-end; text-align:right; }
        .sender{ font-size:.7rem; color:#65676b; margin-bottom:2px; font-weight:600; }
        .bubble{ padding:10px 14px; border-radius:18px; font-size:.9rem; line-height:1.4; }
        .me .bubble{ background:#0084ff; color:#fff; border-bottom-right-radius:4px; }
        .other .bubble{ background:#e4e6eb; color:#050505; border-bottom-left-radius:4px; }

        /* INPUT AREA */
        .input-area{ background:#fff; padding:12px; display:flex; gap:10px; border-top:1px solid #ddd; }
        .input-area input{ flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none; background:#f0f2f5; }
        .input-area button{ padding:0 20px; border:none; border-radius:20px; background:#4267B2; color:#fff; font-weight:600; cursor:pointer; }
    </style>
</head>
<body>

<div id="login-screen">
  <div class="login-card">
    <h1>UJJAIN CHAT</h1>
    <p>Select Your Name</p>
    <select id="nameSelect">
      <option value="">-- Choose Name --</option>
      <option value="Adhyan Sarthak">Adhyan Sarthak</option>
      <option value="Sweta Kumari">Sweta Kumari</option>
      <option value="Mummy">Mummy</option>
      <option value="Papa">Papa</option>
      <option value="Ananya Anand">Ananya Anand</option>
    </select>
    <button onclick="login()">Join Family Chat</button>
  </div>
</div>

<header>
  <div><h2 style="font-size:1rem;">UJJAIN CHAT</h2><small>Family Group</small></div>
  <div class="header-btns">
    <button id="video-btn" onclick="toggleVideoCall()" style="background:#6f42c1;">ðŸ“¹ Video</button>
    <button id="call-btn" onclick="toggleVoiceCall()" style="background:#25D366;">ðŸ“ž Voice</button>
    <button onclick="logout()" style="background:rgba(255,255,255,0.2)">Exit</button>
  </div>
</header>

<div id="video-container"></div>

<div id="chat-box"></div>

<form class="input-area" id="chat-form">
  <input id="msg-input" placeholder="write text here..." autocomplete="off">
  <button type="submit">Send</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtsDXCwGOv8ym4RPn3EziO2O8zuaSDTGc",
    authDomain: "chatword-4d676.firebaseapp.com",
    projectId: "chatword-4d676",
    storageBucket: "chatword-4d676.firebasestorage.app",
    messagingSenderId: "434457097920",
    appId: "1:434457097920:web:61678bc766f8e398b35f25"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "family_chat");
const user = localStorage.getItem("family_user");

if (user) document.getElementById("login-screen").style.display = "none";

window.login = () => {
  const name = document.getElementById("nameSelect").value;
  if (name) { localStorage.setItem("family_user", name); location.reload(); }
  else { alert("Please select a name!"); }
};
window.logout = () => { localStorage.removeItem("family_user"); location.reload(); };

// --- CHAT LOGIC ---
document.getElementById("chat-form").addEventListener("submit", async e => {
  e.preventDefault();
  const text = document.getElementById("msg-input").value.trim();
  if (text && user) {
    await addDoc(colRef, { sender: user, text: text, time: serverTimestamp() });
    document.getElementById("msg-input").value = "";
  }
});

onSnapshot(query(colRef, orderBy("time","asc")), snap => {
  const chatBox = document.getElementById("chat-box");
  chatBox.innerHTML = "";
  snap.forEach(d => {
    const m = d.data();
    const isMe = m.sender === user;
    chatBox.innerHTML += `
      <div class="msg ${isMe ? 'me' : 'other'}">
        <div class="sender">${m.sender}</div>
        <div class="bubble">${m.text}</div>
      </div>`;
  });
  chatBox.scrollTop = chatBox.scrollHeight;
});

// --- AGORA VIDEO/VOICE LOGIC (FIXED) ---
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localTracks = { videoTrack: null, audioTrack: null };
let inCall = false;

const options = {
    appId: "79bdf9897e5446d3a9052d69ada91767",
    channel: "family_room",
    token: null
};

async function join(withVideo) {
    try {
        await client.join(options.appId, options.channel, null);
        localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        
        if (withVideo) {
            localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();
            document.getElementById("video-container").style.display = "grid";
            const player = document.createElement("div");
            player.id = "local-player";
            player.className = "video-view";
            player.innerHTML = `<div class="video-label">You (${user})</div>`;
            document.getElementById("video-container").appendChild(player);
            localTracks.videoTrack.play("local-player");
            await client.publish([localTracks.audioTrack, localTracks.videoTrack]);
        } else {
            await client.publish([localTracks.audioTrack]);
        }
        inCall = true;
    } catch (err) {
        console.error("Join Error:", err);
        alert("Could not access camera/mic.");
    }
}

async function leave() {
    for (let trackName in localTracks) {
        let track = localTracks[trackName];
        if (track) { track.stop(); track.close(); localTracks[trackName] = null; }
    }
    await client.leave();
    
    // UI Reset
    document.getElementById("video-container").style.display = "none";
    document.getElementById("video-container").innerHTML = "";
    
    const vBtn = document.getElementById("video-btn");
    vBtn.innerText = "ðŸ“¹ Video"; vBtn.style.background = "#6f42c1";
    
    const cBtn = document.getElementById("call-btn");
    cBtn.innerText = "ðŸ“ž Voice"; cBtn.style.background = "#25D366";
    
    inCall = false;
}

window.toggleVoiceCall = async () => {
    const btn = document.getElementById("call-btn");
    if (!inCall) {
        await join(false);
        btn.innerText = "âŒ End Voice"; btn.style.background = "#ff4444";
    } else {
        await leave();
    }
};

window.toggleVideoCall = async () => {
    const btn = document.getElementById("video-btn");
    if (!inCall) {
        await join(true);
        btn.innerText = "âŒ End Video"; btn.style.background = "#ff4444";
    } else {
        await leave();
    }
};

client.on("user-published", async (remoteUser, mediaType) => {
    await client.subscribe(remoteUser, mediaType);
    if (mediaType === "video") {
        document.getElementById("video-container").style.display = "grid";
        let player = document.getElementById(`user-${remoteUser.uid}`);
        if (!player) {
            player = document.createElement("div");
            player.id = `user-${remoteUser.uid}`;
            player.className = "video-view";
            player.innerHTML = `<div class="video-label">Family Member</div>`;
            document.getElementById("video-container").appendChild(player);
        }
        remoteUser.videoTrack.play(player.id);
    }
    if (mediaType === "audio") { remoteUser.audioTrack.play(); }
});

client.on("user-unpublished", (remoteUser) => {
    const player = document.getElementById(`user-${remoteUser.uid}`);
    if (player) player.remove();
});
</script>
</body>
</html>